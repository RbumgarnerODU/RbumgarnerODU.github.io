<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargrave Team Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .step {
            margin-bottom: 20px;
        }
        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .stat-change {
            color: red;
        }
        
    </style>
</head>
<body>
    <!-- Minified version -->
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <h1>Stargrave Team Generator</h1>

    <!-- Step 1: Captain's Name -->
    <div class="step" id="step1">
        <label for="captainName">Captain's Name:</label>
        <input type="text" id="captainName" required>
        <button onclick="completeStep1()">Next</button>
    </div>
	
	        <iframe title="Name Generator" src="https://null.perchance.org/87fvvu4w42" style="width:100%; height:200px; border:none;"></iframe>
        
        <iframe title="Character Background" src="https://null.perchance.org/r5i6n2la5r" style="width:100%; height:600px; border:none;"></iframe>

    <!-- Step 2: Captain Type -->
    <div class="step disabled" id="step2">
        <label for="captainType">Select Captain Type:</label>
        <select id="captainType">
            <option value="" disabled selected>Select...</option>
            <option value="Biomorph">Biomorph</option>
            <option value="Cyborg">Cyborg</option>
            <option value="Mystic">Mystic</option>
            <option value="Robotics Expert">Robotics Expert</option>
            <option value="Rogue">Rogue</option>
            <option value="Psionicist">Psionicist</option>
            <option value="Tekker">Tekker</option>
            <option value="Veteran">Veteran</option>
        </select>
        <button onclick="completeStep2()">Next</button>
    </div>

    <!-- Step 3: Dynamically Generated Stat Improvement Section -->
    <div class="step disabled" id="step3">
        <h3>Select Stat Improvements</h3>
        <div id="statImprovement"></div>
        <p id="checkboxLimit"></p>
        <button onclick="completeStep3()">Apply and Show Stats</button>
    </div>
    
    <!-- Step 4: Select Powers -->
    <div class="step disabled" id="step4">
        <h3>Select Powers</h3>
        <h5>Mouseover checkbox for power description</h5>
        <h4>Pick 5 Total</h4>
        <h5>Pick 3-4 (Core)</h5>
        <div id="powersSelection"></div>
        <h5>Pick 1-2 (All)</h5>
        <div id="powersSelection2">
        <table>
            <tr>
                <td id="powers2_1">-</td>
                <td id="powers2_2">-</td>
                <td id="powers2_3">-</td>
            </tr>
        </table>
        </div>
        <button onclick="completeStep4()">Finish and Show Summary</button>
    </div>
    
    <!-- Step 5: Display Stats Table -->
    <div class="step disabled" id="step5">
        <h3>Captain's Stats</h3>
        <table id="statsTable">
            <thead>
                <tr>
                    <th>Captain Name</th>
                    <th>Captain Type</th>
                    <th>Move (M)</th>
                    <th>Fight (F)</th>
                    <th>Shoot (S)</th>
                    <th>Armor (A)</th>
                    <th>Will (W)</th>
                    <th>Health (H)</th>
                    <th>Powers</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="displayCaptainName">-</td>
                    <td id="displayCaptainType">-</td>
                    <td id="displayMove">-</td>
                    <td id="displayFight">-</td>
                    <td id="displayShoot">-</td>
                    <td id="displayArmor">-</td>
                    <td id="displayWill">-</td>
                    <td id="displayHealth">-</td>
                    <td id="displayPowers">-</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="powers_div">
        <h3>Used Powers</h3>
        <table id="powers_table">
            <thead>
                <tr>
                    <th>Power</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody id='table_body'>

            </tbody>
        </table>
    </div>
    
    <script>
        // Default stats for each captain
        let stats = {
            move: 6,
            fight: 3,
            shoot: 2,
            armor: 9,
            will: 3,
            health: 16,
            move_bonus: 0,
            fight_bonus: 0,
            shoot_bonus: 0,
            armor_bonus: 0,
            will_bonus: 0,
            health_bonus: 0
        };
        
        let selectedPowers = [];
        
        let job_powers = new Map([
            ["Biomorph", ["Adrenaline Surge", "Armour Plates", "Camouflage", "Fling", "Regenerate", "Restructure Body", "Toxic Claws", "Toxic Secretion"]],
            ["Cyborg", ["Camouflage", "Control Robot", "Data Knock", "Energy Shield", "Power Spike", "Quick-Step", "Target Lock", "Temporary Upgrade"]],
            ["Mystic", ["Control Animal", "Dark Energy", "Heal", "Life Leech", "Mystic Trance", "Puppet Master", "Suggestion", "Void Blade"]],
            ["Robotics Expert", ["Expert", "Control Robot", "Create Robot", "Drone", "Electromagnetic Pulse", "Remote Firing", "Remote Guidance", "Repair Robot", "Re-wire Robot"]],
            ["Rogue", ["Bait and Switch", "Bribe", "Cancel Power", "Concealed Firearm", "Data Jump", "Fortune", "Haggle", "Quick-Step"]],
            ["Psionicist", ["Break Lock", "Destroy Weapon", "Lift", "Psionic Fire", "Psychic Shield", "Pull", "Suggestion", "Wall of Force"]],
            ["Tekker", ["Anti-Gravity Projection", "Data Jump", "Data Knock", "Data Skip", "Drone", "Electromagnetic Pulse", "Holographic Wall", "Transport"]],
            ["Veteran", ["Armoury", "Command", "Coordinated Fire", "Energy Shield", "Fortune", "Power Spike", "Remote Firing", "Target Designation"]]
        ]);
        
        let all_powers = new Map([
            ['Adrenaline Surge','[Activation: 12 / Strain: 2 / Self Only] This figure immediately gains an additional action during this activation, and an additional action in their next activation as well.'],
            ['Anti-gravity Projection','[Activation: 10 / Strain: 0 / Line of Sight] The target figure gains the Levitate attribute (page 156) for the rest of the game.'],
            ['Armour Plates','[Activation: 10 / Strain: 2 / Self Only or Out of Game (B)] The figure gains +2 Armour. This power may not be used if the figure is already wearing combat armour. This power can be used Out of Game (B), in which case the activatingfigure starts the game at -2 Damage to represent the Strain.'],
            ['Armoury','[Activation: 10 / Strain: 0 / Out of Game (B)] The crew can field one suit of combat armour without having to pay is normal upkeep cost. Alternatively, one standard (not Advanced Technology) pistol, carbine, or shotgun may be given a +1 Damage modifier for the next game only.'],
            ['Bait and Switch','[Activation: 12 / Strain: 2 / Line of Sight] This power may only be used against a soldier carrying a loot token. That figure must make an immediate Will Roll (TN14). If failed, the figure immediately drops the loot token and the activator may move it up to 4\" in any direction.'],
            ['Break Lock','[Activation: 12 / Strain: 1 / Line of Sight] Immediately unlocks one physical-loot counter.'],
            ['Bribe','[Activation: 14 / Strain: 0 / Out of Game (B)] If successful, place one bribe token next to the table and make your opponent aware of it. At any point of the game, when your opponent declares that a soldier (not a captain or first mate) is making a Shooting attack, but before the dice are rolled, you may play your bribe token. The Shooting attack automatically misses, and no dice are rolled. No crew may use more than one bribe token in any game.'],
            ['Camouflage','[Activation: 10 / Strain: 2 / Self Only] No figure may draw line of sight to this figure if it is more than 12\" away. In addition, it gains +2 Fight when rolling against Shooting attacks from pistol, carbine, shotgun, or rapid-fire attacks. This power is cancelled if the figure becomes stunned.'],
            ['Cancel Power','[Activation: 12 / Strain: 1 / Line of Sight] Immediately cancels all effects of one ongoing Line of Sight power. It has no effect on powers with other designations.'],
            ['Command','[Activation: 10 / Strain: 0 / Line of Sight] Select one member of the crew that is in line of sight. That figure now activates in the current player\'s phase this turn. This power may not be used on a figure that has already activated in this turn.'],
            ['Concealed Firearm','[Activation: 10 / Strain: 1 / Self Only] This power may only be used while a figure is in combat. The figure may make one +5 Shooting attack against any other figure in the combat. Do not randomize the target of the attack, even if there are multiple figures in the combat. If this attack damages the target, it is automatically pushed back 1\" and stunned, even if the attack did less than 4 Damage.'],
            ['Control Animal','[Activation: 10 / Strain: 1 / Line of Sight] This power may only be used against uncontrolled animals. The target animal must make an immediate Will Roll (TN16) or become a temporary member of the same crew as the activator. Each figure with this power may only have one animal under control at any time. They may cancel this power at any time as a free action.'],
            ['Control Robot','[Activation: 10 / Strain: 1 / Line of Sight] Select one robot in line of sight. That robot must make an immediate Will Roll (TN15). If it succeeds, nothing happens. If it fails, it immediately joins the crew of activator as a temporary member. The controlled robot may make a new Will Roll (TN15) after each of its activations. If it succeeds this power is canceled and the robot immediately reverts to its previous allegiance. A figure with this power may only have one robot under control at any time. They may cancel this power at any time as a free action.'],
            ['Dark Energy','[Activation: 10 / Strain: 1 / Line of Sight] The figure makes a +5 Shooting attack against any target within 12\". This attack ignores any armour worn by a figure (so subtract a figure\'s armour modifier from their armour). Increase this attack to +7 against robots. If this attack targets a figure in combat, do not randomize the target, it can only hit the intended target. (Armour Interference).'],
            ['Data Jump','[Activation: 10 / Strain: 1 / Line of Sight] This power may only target a member of the same warband that is carrying a data-loot token. The player may immediately move the data-loot token carried by that figure to another member of the crew, provided both are in line of sight of the activator and within 8\" of one another.'],
            ['Data Knock','[Activation: 12 / Strain: 1 / Line of Sight] Immediately unlocks one data-loot counter.'],
            ['Data Skip','[Activation: 12 / Strain: 2 / Line of Sight] This power targets an unlocked data-loot token or a figure carrying such a token that is within 12\". If the token is not being carried, the activator may move the data-loot token 4\" in any direction. If a figure is carrying the token, then that figure must make a Will Roll (TN16). If failed, the activator may move the data-loot token up to 4\" in any direction. Either way, the token remains unlocked.'],
            ['Destroy Weapon','[Activation: 12 / Strain: 2 / Line of Sight] This power may be used against any figure within 12\". The activator may choose one weapon carried by that figure to be destroyed, except indestructible weapons. This weapon is replaced for free after the game. (Armour Interference).'],
            ['Drone', '[Activation: 10 / Strain: 1 / Touch] Place a drone next to the activator (see Chapter Six: Bestiary, page 144). This drone counts as a temporary member of the crew, and may activate and move as normal. For the rest of the game, the figure may draw line of sight from the drone, instead of the figure, when using a power. This includes using Touch powers. A figure may only have one active drone at a time.'],
            ['Electromagnetic Pulse','[Activation: 10 / Strain: 1 / Line of Sight] If targeted against a robot, that robot must make an immediate Will Roll (TN18). If it fails, it receives no actions the next time it activates. If targeted against a non-robot figure, all firearms carried by that figure immediately jam as though they had rolled a 1 on a Shooting attack. Additionally, the weapon suffers a -1 Damage modifier for the rest of the game. A weapon can be jammed in multiple turns through the use of this power, but the Damage modifier only applies the first time.'],
            ['Energy Shield','[Activation: 10 / Strain: 0 / Self Only] A small energy shield forms around the user. This shield absorbs the next 3 points of Damage from any Shooting attack that would injure the activator. Once 3 points of Damage have been absorbed, the power is cancelled.'],
            ['Fling','[Activation: 8 / Strain: 1 / Self Only or Touch] This power can be used in two ways. The activator may use it while standing within 1\" of a member of their crew, in which case they may immediately move that crewmember 6\" in any direction, including up. However, the figure that was moved is immediately stunned. Alternatively, it can be used while in combat against a specific enemy figure. The target figure must make an immediate Fight Roll (TN16). If it fails, the activator may move the target figure up to 6\" in any horizontal direction. The figure takes no Damage (unless there is another reason it would, such as falling), but is stunned. This power may not be used on any figure that has the Large attribute.'],
            ['Fortune','[Activation: 12 / Strain: 0 / Self Only] Place a fortune token either next to the figure or on your crew sheet next to the figure\'s entry. At any point the player may discard this token to reroll a Combat Roll, Shooting Roll, or Stat Roll made by that figure. If used, the figure must take the result of the reroll, they cannot choose to take the original roll. No figure may have more than one fortune token at one time.'],
            ['Haggle','[Activation: 10 / Strain: 0 / Out of Game (A)] This power may be used whenever the crew sells anything. The crew receives 20% more than the usual selling price. This power may only be used on the sale of one item after each game.'],
            ['Heal','[Activation: 10 / Strain: 0 / Line of Sight] This power restores up to 5 points of lost Health to a target figure within 6\". This power cannot take a figure above its starting Health. This power has no effect on robots. (Armour Interference). '],
            ['Holographic Wall','[Activation: 10 / Strain: 1 / Line of Sight] Creates a holographic wall 6\" long and 3\" high. No line of sight may be drawn through this wall. Figures may move through the wall as though it is not there. At the end of each turn, after the turn in which the wall is placed, roll a die. On a 14 the holograph fails, and the wall is removed.'],
            ['Life Leech','[Activation: 10 / Strain: 0 / Line of Sight] The target must make an immediately Will Roll (TN15). If failed the target loses 3 Health and the figure using the power regains 3 Health. This may not take a figure above its starting Health. This power cannot be used against robots. A figure may use this power on a member of their own crew, but if so, that figure is immediately removed from the crew sheet and counts as an uncontrolled figure for the rest of the game. (Armour Interference). '],
            ['Lift','[Activation: 10 / Strain: 0 / Line of Sight] Immediately move one member of the same crew that is in line of sight 6\" in any direction, including vertically. If this leaves the figure hanging above the ground, it immediately drops to the ground, but takes no Damage. The figure that is moved cannot take any additional actions this turn, though may have taken actions previously this turn. This may not move a figure off the table. (Armour Interference).'],
            ['Mystic Trance','[Activation: 8 / Strain: 0 / Out of Game (B)] If successfully activated, the figure may attempt to use one of their other powers before the first Initiative Roll as if it was an Out of Game (B) power. No power that targets a point on the table or an enemy figure can be used with Mystic Trance.'],
            ['Power Spike','[Activation: 8 / Strain: 1 / Self Only] The next time this figure makes a Shooting attack with a carbine, pistol, or shotgun, the shot does +3 Damage. This is cumulative with other damage modifiers for the weapon. For example, the total modifier would +4 in the case of a shotgun (+3 from Power Spike and +1 from the Shotgun).'],
            ['Psionic Fire','[Activation: 10 / Strain: 1 / Self Only] The activator should place two flamethrower templates as thought the figure had just made a flamethrower attack. These templates may be touching, but may not overlap. Every figure touching a template immediately suffers a +3 flamethrower attack (see page 57). Figures only suffer one attack even if touching both templates. (Armour Interference).'],
            ['Pull','[Activation: 12 / Strain: 1 / Line of Sight] The target figure must make a Will Roll (TN16). If it fails, move that figure up to 6\" in any horizontal direction. This may not move a figure over terrain more than 0.5\" high. If this moves them off terrain that is above the ground, they fall and take Damage as normal. (Armour Interference).'],
            ['Puppet Master','[Activation: 12 / Strain: 2 / Touch] Choose one non-robot member of the crew that has been reduced to 0 Health during the game. That soldier returns to the table, adjacent to the figure activating this power. The soldier has 1 Health and counts as wounded. They are treated as a normal soldier in every other way. Any given soldier may only be returned to the table once each game through the use of Puppet Master. (Armour Interference).'],
            ['Psychic Shield','[Activation: 10 / Strain: 2 / Line of Sight] The target figure is surrounded by psychic energy. The next time it is hit with a Shooting attack that causes Damage of any amount, halve that Damage (rounding down), and then the power is cancelled. It this figure is ever in combat, this power is immediately cancelled. If the figure also has an active Energy Shield, deduct then 3 points of Damage for it first, then halve the remaining for the Psychic Shield. (Armour Interference).'],
            ['Regenerate','[Activation: 8 / Strain: 0 / Self Only] The activator regains up to 3 points of lost Health.'],
            ['Remote Guidance','[Activation: 10 / Strain: 0 / Out of Game (B) or Touch] This power may be used on any robot soldier. That robot can always activate in the same phase as the activator, even if it is not within 3\". The player is still limited to a maximum of three soldiers activating in either the Captain or First Mate Phase. An activator may only use Remote Guidance on one robot at a time.'],
            ['Remote Firing','[Activation: 10 / Strain: 0 / Line of Sight] This power allows the user to select one robot in the same crew that is within line of sight. That robot makes an immediate +3 Shooting attack against any legal target within 12\". This attack does not count as the robot\'s activation, nor does it cost the robot an action.'],
            ['Repair Robot','[Activation: 10 / Strain: 0 / Line of Sight] This power restores up to 5 points of lost Health to a target robot within 6\". This power cannot take a figure above its starting Health.'],
            ['Restructure Body', '[Activation: 10 / Strain: 0 / Self Only or Out of Game (B)] The activator gains one of the following traits of its choice: Amphibious, Burrowing, Expert Climber, Immune to Critical Hits, Immune to Toxins, or Never Wounded. It may only gain one of these traits at a time, but can change the attribute from one to another with an additional use of the power.'],
            ['Quick-Step','[Activation: 10 / Strain: 1 / Self Only] A figure may not make a Power Move when attempting to activate this power. The activator may immediately move 4\" in any direction, including out of combat. No figure may force combat during this move. The activator may not end this move within 1\" of an enemy figure nor exit the table using this move. This move does not suffer any movement penalties for terrain. If the figure fails its activation, it may make a normal Power Move.'],
            ['Re-wire Robot','[Activation: 14 / Strain: 0 / Out of Game (B)] Select one robot in the crew. The robot may be given one of the following enhancements: +1 Move, +1 Fight, +1 Armour; however, it suffers -1 Will. These modifications are permanent. No robot may be re-wired more than once.'],
            ['Suggestion','[Activation: 12 / Strain: 1 / Line of Sight] The target of this power must make an immediate Will Roll (TN16). If it fails, it drops any loot it is carrying, and the activator may move the figure up to 3\" in any direction, provided this does not move the figure into combat or cause it any immediate Damage (i.e. falling more than 3\"). (Armour Interference).'],
            ['Target Designation',' [Activation: 8 / Strain: 0 / Line of Sight] For the rest of the battle, this figure receives -2 Fight whenever rolling against a Shooting attack.'],
            ['Target Lock','[ Activation: 10 / Strain: 1 / Touch] The activator may make an immediate grenade or grenade launcher attack as a free action against any point in range; it does not have to be in line of sight. The attack automatically hits its intended point. If this power is used during a group activation, then the grenade or grenade launcher attack can be made by another member of the crew that is within 1\" and was part of the group activation.'],
            ['Temporary Upgrade' ,'[Activation: 12 / Strain: 0 / Self Only] The activator may select one of the following stat increases: +1 Move, +1 Fight, +1 Shoot, +3 Will, +1 Armour. These may not take the figure above Move (7), Fight (+6), Shoot (+6), Will (+8), or Armour (14). A figure may only have one upgrade activate a time, but they may use this power again to switch from one upgrade to another.'],
            ['Toxic Claws', '[Activation: 10 / Strain: 1 / Self Only] The figure immediately grows a set of indestructible claws. These count as a hand weapon, do +2 Damage, and are toxic.'],
            ['Toxic Secretion', '[Activation: 12 / Strain: 0 / Out of Game (B)] The activator may select up to two members of their crew, including itself. All attacks made by those figures, including Shooting attacks, count as toxic for the next game.'],
            ['Transport', '[Activation: 10 / Strain: 1 / Line of Sight] May target one member of the same crew that is within Line of Sight and 12\" from the activator. This figure can be moved up to 6\" in any direction (maintaining line of sight). If the figure was carrying a loot token, the token is dropped and not moved with the figure.'],
            ['Void Blade','[Activation: 10 / Strain: 0 / Self Only] A figure must be carrying a hand weapon in order to use this power. This hand weapon becomes indestructible and does +2 Damage. In addition, the figure receives +3 Fight whenever they are rolling against a Shooting attack generated by a pistol, carbine, rapid-fire, or shotgun. This bonus does not stack with cover; the player should use whichever modifier is greater. If this figure ever becomes stunned, this power is immediately cancelled. A figure with an active void blade cannot use any weapon that takes up more than 1 gear slot.'],
            ['Wall of Force', '[Activation: 12 / Strain: 1 / Self Only] Creates an impenetrable, transparent wall, up to 6\" long and 3\" high anywhere within line of sight of the activator. This wall cannot be climbed (though any point it is anchored on may be). Grenade and grenade launcher attacks may be made over the wall. Figures may make a Shooting action at the wall. In that case, roll a die, on a 19/20, the wall is immediately cancelled.']
        ]);

        var captainType = null;
        
        function defaultCaptainStats() {
            stats.move = 6,
            stats.fight = 3,
            stats.shoot = 2,
            stats.armor = 9,
            stats.will = 3,
            stats.health = 16,
            stats.move_bonus = 0,
            stats.fight_bonus = 0,
            stats.shoot_bonus = 0,
            stats.armor_bonus = 0,
            stats.will_bonus = 0,
            stats.health_bonus = 0
        }       
        
        let maxCheckboxes = 0;
        
        let maxCheckboxesCore = 4;
        
        let maxCheckboxesAll = 2;

        // Step 1: Complete Captain's Name
        function completeStep1() {
            const captainName = document.getElementById('captainName').value;
            if (captainName) {
                document.getElementById('step2').classList.remove('disabled');
                document.getElementById('step1').classList.add('disabled');
                defaultCaptainStats()
            } else {
                alert("Please enter the captain's name.");
            }
        }

        // Step 2: Complete Captain Type Selection
        function completeStep2() {
            captainType = document.getElementById('captainType').value;
            if (captainType) {
                document.getElementById('step3').classList.remove('disabled');
                document.getElementById('step2').classList.add('disabled');
                defaultCaptainStats()
                setCaptainStatsJob();
                generateStatImprovementOptions();
            } else {
                alert("Please select a captain type.");
            }
        }

        // Dynamically generate stat improvement options based on captain type
        function generateStatImprovementOptions() {
            const statImprovementDiv = document.getElementById('statImprovement');
            const checkboxLimitText = document.getElementById('checkboxLimit');
            statImprovementDiv.innerHTML = '';  // Clear previous options

            let options = [];
            if (captainType === 'Biomorph' || captainType === 'Cyborg' || captainType === 'Rogue') {
                options = [
                    {label: 'Increase Move by 1', stat: 'move', value: 1},
                    {label: 'Increase Fight by 1', stat: 'fight', value: 1},
                    {label: 'Increase Shoot by 1', stat: 'shoot', value: 1}
                ];
                maxCheckboxes = 2;
            } else if (captainType === 'Mystic' || captainType === 'Psionicist' || captainType === 'Veteran') {
                options = [
                    {label: 'Increase Move by 1', stat: 'move', value: 1},
                    {label: 'Increase Fight by 1', stat: 'fight', value: 1},
                    {label: 'Increase Shoot by 1', stat: 'shoot', value: 1}
                ];
                maxCheckboxes = 1;
            } else if (captainType === 'Robotics Expert' || captainType === 'Tekker') {
                options = [
                    {label: 'Increase Move by 1', stat: 'move', value: 1},
                    {label: 'Increase Fight by 1', stat: 'fight', value: 1},
                    {label: 'Increase Shoot by 1', stat: 'shoot', value: 1},
                    {label: 'Increase Health by 1', stat: 'health', value: 1}
                ];
                maxCheckboxes = 2;
            }

            // Update checkbox limit display
            checkboxLimitText.innerText = `You can select up to ${maxCheckboxes} improvements.`;

            // Create checkboxes for each option
            options.forEach((option, index) => {
                const checkboxInput = document.createElement('input');
                checkboxInput.type = 'checkbox';
                checkboxInput.name = 'statImprovement';
                checkboxInput.id = `option${index}`;
                checkboxInput.value = JSON.stringify(option);
                checkboxInput.onclick = limitCheckboxes;

                const label = document.createElement('label');
                label.htmlFor = `option${index}`;
                label.innerText = option.label;

                const br = document.createElement('br');

                statImprovementDiv.appendChild(checkboxInput);
                statImprovementDiv.appendChild(label);
                statImprovementDiv.appendChild(br);
            });
        }

        // Limit the number of checkboxes that can be selected
        function limitCheckboxes() {
            const checkboxes = document.querySelectorAll('input[name="statImprovement"]:checked');
            if (checkboxes.length > maxCheckboxes) {
                this.checked = false;
                alert(`You can only select up to ${maxCheckboxes} improvements.`);
            }
        }

        // Step 3: Apply selected stat improvement and proceed
        function completeStep3() {
            const selectedOptions = document.querySelectorAll('input[name="statImprovement"]:checked');
            if (selectedOptions.length == maxCheckboxes) {
                selectedOptions.forEach(option => {
                    const { stat, value } = JSON.parse(option.value);
                    updateStatsTable(stat, value);
                });
                document.getElementById('step4').classList.remove('disabled');
                document.getElementById('step3').classList.add('disabled');
                generatePowersSelection();
            } else {
                alert(`You must select ${maxCheckboxes} improvement(s).`);
            }
        }
        
        // Reset captains stats to default
        function setCaptainStatsJob() {
            // Adjust stats based on Captain Type
            switch (captainType) {
                case 'Cyborg':
                case 'Biomorph':
                    stats.health_bonus += 1;
                    break;
                case 'Mystic':
                    stats.health_bonus += 1;
                    stats.will_bonus += 2;
                    break;
                case 'Robotics Expert':
                    stats.will_bonus += 1;
                    break;
                case 'Rogue':
                    stats.health_bonus += 1;
                    stats.will_bonus += 1;
                    break;
                case 'Psionicist':
                    stats.health_bonus += 1;
                    stats.will_bonus += 2;
                    break;
                case 'Tekker':
                    stats.will_bonus += 2;
                    break;
                case 'Veteran':
                    stats.fight_bonus += 1;
                    stats.health_bonus += 1;
                    break;
            }
        }
        
        function insertCharacter(originalString, charToInsert, index) {
            // Check if the index is within bounds
            if (index < 0 || index > originalString.length) {
                throw new Error("Index out of bounds");
            }

            // Use substring to create a new string with the character inserted
            const newString = originalString.substring(0, index) + charToInsert + originalString.substring(index);
            return newString;
}
        
        // Step 5: Finish and Show Summary
        function completeStep4() {
            const checkboxesCore = document.querySelectorAll('input[name="powerSelection"]:checked');
            const checkboxesAll = document.querySelectorAll('input[name="powerSelection2"]:checked');
            if ((checkboxesAll.length + checkboxesCore.length) < 5 || (checkboxesAll.length + checkboxesCore.length) > 5) {
                alert(`You must select exactly 5 powers.`);
            } else {
                document.getElementById('displayCaptainName').innerText = document.getElementById('captainName').value;
                document.getElementById('displayCaptainType').innerText = document.getElementById('captainType').value;
                const powersDiv = document.getElementById('displayPowers');
                powersDiv.innerHTML = '';
                
                                // Get the table body element
                const tableBody = document.getElementById('table_body');
                
                // Iterate over the NodeList of checked checkboxes
                checkboxesCore.forEach((checkbox) => {
                    // Create a new table row element
                    const newRow = document.createElement('tr');

                    // Create cells for the new row
                    const nameCell = document.createElement('td');
                    nameCell.textContent = `${checkbox.value}`; // Example name
                    newRow.appendChild(nameCell);

                    const decriptionCell = document.createElement('td');
                    const description = `<b><strong>${all_powers.get(checkbox.value)}`;
                    const bracket_index = description.indexOf("]");
                    const string_1 = description.substr(0,bracket_index+1) + "</strong></b>";
                    const total_string = string_1 + description.substr(bracket_index+1);
                    
                    decriptionCell.innerHTML = `${total_string}`
                    newRow.appendChild(decriptionCell);
                    
                    tableBody.appendChild(newRow);
                    
                    const label = document.createElement('label');
                    label.innerText = checkbox.value;
                    label.title = all_powers.get(checkbox.value)
                    powersDiv.append(label)
                    const hr = document.createElement('hr');
                    powersDiv.appendChild(hr);
                });
                checkboxesAll.forEach((checkbox) => {
                    // Create a new table row element
                    const newRow = document.createElement('tr');

                    // Create cells for the new row
                    const nameCell = document.createElement('td');
                    nameCell.textContent = `${checkbox.value}`; // Example name
                    newRow.appendChild(nameCell);

                    const decriptionCell = document.createElement('td');
                    const description = `<b><strong>${all_powers.get(checkbox.value)}`
                    const bracket_index = description.indexOf("]");
                    const detail_block = description.substr(0,bracket_index+1) + "</strong></b>";
                    const total_string = detail_block + description.substr(bracket_index+1);
                    
                    decriptionCell.innerHTML = `${total_string}`; // Example age
                    newRow.appendChild(decriptionCell);
                    
                    tableBody.appendChild(newRow);
                    
                    const label = document.createElement('label');
                    label.innerText = checkbox.value;
                    label.title = all_powers.get(checkbox.value)
                    powersDiv.append(label)
                    const hr = document.createElement('hr');
                    powersDiv.appendChild(hr);
                });
                if (powersDiv.lastElementChild) {
                    powersDiv.removeChild(powersDiv.lastElementChild);
                }
                document.getElementById('step5').classList.remove('disabled');
                document.getElementById('step4').classList.add('disabled');
            }
            
        }
        
        function limitCheckboxesPowersCore() {
            const checkboxes = document.querySelectorAll('input[name="powerSelection"]:checked');
            if (checkboxes.length > maxCheckboxesCore) {
                this.checked = false;
                alert(`You can only select up to ${maxCheckboxesCore} core powers.`);
            }
        }
        
        function limitCheckboxesPowersAll() {
            const checkboxes = document.querySelectorAll('input[name="powerSelection2"]:checked');
            if (checkboxes.length > maxCheckboxesAll) {
                this.checked = false;
                alert(`You can only select up to ${maxCheckboxesAll} powers from the overall list.`);
            }
        }
        
        // Update the Stats Table based on Captain Type and applied improvement
        function updateStatsTable(improvedStat = null, improvementValue = 0) {
            
            const captainName = document.getElementById('captainName').value;
            const captainType = document.getElementById('captainType').value;

            // Apply additional improvement from checkbox selection
            if (improvedStat && stats.hasOwnProperty(improvedStat)) {
                stats[improvedStat+"_bonus"] += improvementValue;
            }

            // Update table with values and highlight changes in red with parentheses
            document.getElementById('displayCaptainName').innerText = captainName;
            document.getElementById('displayCaptainType').innerText = captainType;

            updateStatDisplay('displayMove', stats.move, stats.move_bonus);
            updateStatDisplay('displayFight', stats.fight, stats.fight_bonus);
            updateStatDisplay('displayShoot', stats.shoot, stats.shoot_bonus);
            updateStatDisplay('displayArmor', stats.armor, stats.armor_bonus);
            updateStatDisplay('displayWill', stats.will, stats.will_bonus);
            updateStatDisplay('displayHealth', stats.health, stats.health_bonus);
        }
       
        // Step 4: Generate Power Selection Based on Captain Type
        function generatePowersSelection() {
            
            const powersSelectionDiv = document.getElementById('powersSelection');
            powersSelectionDiv.innerHTML = '';  // Clear previous options

            let powers = job_powers.get(captainType);
            for (let i = 0; i < powers.length; i++) {
                power = powers[i];
                const checkboxInput = document.createElement('input');
                checkboxInput.type = 'checkbox';
                checkboxInput.name = 'powerSelection';
                checkboxInput.id = `power${i}`;
                checkboxInput.value = power;
                checkboxInput.onclick = limitCheckboxesPowersCore;
                checkboxInput.setAttribute('title',all_powers.get(power))
                const label = document.createElement('label');
                label.htmlFor = `power${i}`;
                label.innerText = power;

                const br = document.createElement('br');

                powersSelectionDiv.appendChild(checkboxInput);
                powersSelectionDiv.appendChild(label);
                powersSelectionDiv.appendChild(br);
            };
            

            // Filter the Map based on the keys in the array
            const filteredPowers = new Map(
              [...all_powers].filter(([key, value]) => !powers.includes(key))
            );
            
            let counter = 1;
            let max_counter = 3;
            for (let j = counter; j <= max_counter; j++) {
                let powersSelectionDiv2 = document.getElementById(`powers2_${j}`);
                powersSelectionDiv2.innerHTML = '';
            }
            
            filteredPowers.forEach((value, key) => {
                let powersSelectionDiv2 = document.getElementById(`powers2_${counter}`);
                  // Clear previous options
                let power_description = all_powers.get(key);
                const checkboxInput = document.createElement('input');
                checkboxInput.type = 'checkbox';
                checkboxInput.name = 'powerSelection2';
                checkboxInput.id = `power${key}`;
                checkboxInput.value = key;
                checkboxInput.onclick = limitCheckboxesPowersAll;
                checkboxInput.setAttribute('title',all_powers.get(key))
                const label = document.createElement('label');
                label.htmlFor = `power${key}`;
                label.innerText = key;
                
                

                powersSelectionDiv2.appendChild(checkboxInput);
                powersSelectionDiv2.appendChild(label);
                const br = document.createElement('br');
                powersSelectionDiv2.appendChild(br);
                counter += 1;
                if (counter > 3) {
                    counter = 1;
                }
            });
        }
        
        
        // Get power description based on power name
        function getPowerDescription(powerName) {
            return all_powers.get(powerName) || 'No description available.';
        }
        
        // Helper function to display the stats with changes in red and parentheses
        function updateStatDisplay(elementId, baseValue, changeValue) {
            const element = document.getElementById(elementId);
            if (changeValue > 0) {
                element.innerHTML = `${baseValue + changeValue} <span class="stat-change">(+${changeValue})</span>`;
            } else {
                element.innerHTML = baseValue;
            }
        }
    </script>

</body>
</html>